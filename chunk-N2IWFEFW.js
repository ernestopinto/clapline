import{f as se,g as ae}from"./chunk-6MVDHSCT.js";import{$ as T,$a as X,Ba as ie,G as ee,Ha as N,Ia as A,Ja as ne,Ka as G,L as Z,La as J,Ma as oe,Na as p,Oa as b,Pa as P,Q as h,Qa as d,R as v,Ra as u,Sa as re,Ta as k,Ua as O,Va as D,Wa as V,X as te,Xa as _,Za as q,_a as F,a as B,aa as C,ab as $,b as U,bb as s,cb as w,db as Q,na as m,ua as H,ya as L}from"./chunk-MHGYNQCG.js";var M=class l{videoSources=T([]);isLoading=T(!1);duration=T(0);currentTime=T(0);isScrubbing=T(!1);isPlayingSubSection=T(!1);subIn=T(null);subOut=T(null);selectedSource=T(null);_video=null;_lastSource=T("video");_cleanup=null;_rangeStopCleanup=null;_rangeStopRafId=null;_rangeStopRvfcId=null;_playAllQueue=null;_playAllIndex=0;_ignoreNextPause=!1;_syncRunning=!1;_rafId=null;_rvfcId=null;_epsilon=1/240;constructor(){this.isLoading.set(!0),setTimeout(()=>{this.videoSources.set([{name:"Woman on the top of the bed",url:"assets/videos/woman.mp4",subSections:[{name:"s1",tcin:"00:00:01",tcout:"00:00:02.5"}]},{name:"Woman dancing on an ancient monument",url:"assets/videos/woman2.mp4",subSections:[{name:"s1",tcin:"00:00:02",tcout:"00:00:03"},{name:"s1",tcin:"00:00:04",tcout:"00:00:10.5"},{name:"s1",tcin:"00:00:13",tcout:"00:00:15"}]},{name:"Sexy lingerie video",url:"assets/videos/anabela.mp4",subSections:[{name:"s1",tcin:"00:00:05",tcout:"00:00:10"},{name:"s2",tcin:"00:00:15",tcout:"00:00:20"}]}]),this.isLoading.set(!1)},1500),C(()=>{let e=this._video,t=this.currentTime(),i=this._lastSource(),n=this.isScrubbing();if(!e||i!=="timeline")return;let o=n?0:.02;if(!(Math.abs(e.currentTime-t)<o))try{e.currentTime=t}catch{}})}connectVideo(e){this._cleanup?.(),this._cleanup=null,this._stopSyncLoop(),this._video=e,this.duration.set(0),this.currentTime.set(e.currentTime||0),this._lastSource.set("video");let t=()=>{let f=e.duration;if(!Number.isFinite(f)||f<=0)try{e.seekable&&e.seekable.length>0&&(f=e.seekable.end(e.seekable.length-1))}catch{}Number.isFinite(f)&&f>0&&this.duration.set(f)},i=()=>{if(this.isScrubbing())return;if(this._lastSource()==="timeline"){let I=this.currentTime(),Y=e.currentTime||0;if(Math.abs(Y-I)>.03)return;this._lastSource.set("video")}let f=e.currentTime||0,R=this.currentTime();Math.abs(f-R)<this._epsilon||(this._lastSource.set("video"),this.currentTime.set(f))},n=()=>{t(),this._lastSource.set("video"),this.currentTime.set(e.currentTime||0),!e.paused&&!e.ended&&this._startSyncLoop(i)},o=()=>this._startSyncLoop(i),r=()=>this._stopSyncLoop(),a=()=>this._stopSyncLoop(),c=()=>{t(),this._lastSource.set("video"),i()},y=()=>{t(),this._lastSource.set("video"),i()},E=()=>i(),g=()=>t(),S=()=>t(),x=()=>t();e.addEventListener("loadedmetadata",n),e.addEventListener("loadeddata",g),e.addEventListener("canplay",S),e.addEventListener("durationchange",x),e.addEventListener("play",o),e.addEventListener("pause",r),e.addEventListener("ended",a),e.addEventListener("seeking",c),e.addEventListener("seeked",y),e.addEventListener("timeupdate",E),e.readyState>=1&&n(),requestAnimationFrame(()=>t()),this._cleanup=()=>{this._stopSyncLoop(),this._clearRangeStop(),e.removeEventListener("loadedmetadata",n),e.removeEventListener("loadeddata",g),e.removeEventListener("canplay",S),e.removeEventListener("durationchange",x),e.removeEventListener("play",o),e.removeEventListener("pause",r),e.removeEventListener("ended",a),e.removeEventListener("seeking",c),e.removeEventListener("seeked",y),e.removeEventListener("timeupdate",E)}}beginScrub(){this.isScrubbing.set(!0)}endScrub(){this.isScrubbing.set(!1)}setTimeFromTimeline(e){let t=this.duration(),i=t>0?Math.max(0,Math.min(t,e)):Math.max(0,e);this._lastSource.set("timeline"),this.currentTime.set(i)}_startSyncLoop(e){let t=this._video;if(!t||this._syncRunning)return;this._syncRunning=!0;let i=t;if(typeof i.requestVideoFrameCallback=="function"){let o=()=>{!this._syncRunning||this._video!==t||(e(),this._rvfcId=i.requestVideoFrameCallback(o))};this._rvfcId=i.requestVideoFrameCallback(o);return}let n=()=>{!this._syncRunning||this._video!==t||(e(),this._rafId=requestAnimationFrame(n))};this._rafId=requestAnimationFrame(n)}_stopSyncLoop(){this._syncRunning=!1,this._rafId!=null&&(cancelAnimationFrame(this._rafId),this._rafId=null);let e=this._video;this._rvfcId!=null&&e&&typeof e.cancelVideoFrameCallback=="function"?(e.cancelVideoFrameCallback(this._rvfcId),this._rvfcId=null):this._rvfcId=null}setSubSection(e,t){let i=this.duration(),n=a=>i>0?Math.max(0,Math.min(i,a)):Math.max(0,a),o=e==null?null:n(e),r=t==null?null:n(t);if(o!=null&&r!=null){let a=Math.min(o,r),c=Math.max(o,r);this.subIn.set(a),this.subOut.set(c);return}this.subIn.set(o),this.subOut.set(r)}setSubIn(e){if(e==null){this.subIn.set(null);return}let t=this.duration(),i=t>0?Math.max(0,Math.min(t,e)):Math.max(0,e);this.subIn.set(i)}setSubOut(e){if(e==null){this.subOut.set(null);return}let t=this.duration(),i=t>0?Math.max(0,Math.min(t,e)):Math.max(0,e);this.subOut.set(i)}updateSubSectionByIndex(e,t,i){let n=this.selectedSource();if(!n||e<0||e>=n.subSections.length)return;let o=n.subSections.map((c,y)=>y!==e?c:U(B({},c),{[t]:i})),r=U(B({},n),{subSections:o});this.selectedSource.set(r);let a=this.videoSources().map(c=>c.url===r.url?r:c);this.videoSources.set(a)}editSubSection(e){let t=this._parseTimecodeToSeconds(e.tcin),i=this._parseTimecodeToSeconds(e.tcout);this.setSubSection(t,i)}playSubSection(e){let t=this._video;if(!t)return;this._clearPlayAllQueue();let i=this._parseTimecodeToSeconds(e.tcin),n=this._parseTimecodeToSeconds(e.tcout);if(i==null||n==null)return;let o=Math.min(i,n),r=Math.max(i,n);this.setSubSection(o,r),this._lastSource.set("timeline"),this.currentTime.set(o),this.isPlayingSubSection.set(!0);try{t.currentTime=o}catch{}this._installRangeStop(r);let a=t.play();a&&typeof a.catch=="function"&&a.catch(()=>{this.isPlayingSubSection.set(!1)})}playAllSections(e){if(!this._video)return;let i=e.filter(n=>{let o=this._parseTimecodeToSeconds(n.tcin),r=this._parseTimecodeToSeconds(n.tcout);return o!=null&&r!=null});i.length!==0&&(this._playAllQueue=i,this._playAllIndex=0,this._playNextInQueue())}_playNextInQueue(){if(!this._playAllQueue)return;if(this._playAllIndex>=this._playAllQueue.length){this._clearPlayAllQueue();return}let e=this._playAllQueue[this._playAllIndex],t=this._parseTimecodeToSeconds(e.tcin),i=this._parseTimecodeToSeconds(e.tcout);if(t==null||i==null){this._playAllIndex+=1,this._playNextInQueue();return}let n=Math.min(t,i),o=Math.max(t,i),r=this._video;if(!r)return;this.setSubSection(n,o),this._lastSource.set("timeline"),this.currentTime.set(n),this.isPlayingSubSection.set(!0);try{r.currentTime=n}catch{}this._installRangeStop(o,()=>{this._playAllIndex+=1,this._playNextInQueue()});let a=r.play();a&&typeof a.catch=="function"&&a.catch(()=>{this.isPlayingSubSection.set(!1),this._clearPlayAllQueue()})}_clearPlayAllQueue(){this._playAllQueue=null,this._playAllIndex=0}_installRangeStop(e,t){let i=this._video;if(!i)return;this._clearRangeStop();let n=()=>{try{i.currentTime=e}catch{}this.currentTime.set(e),this._ignoreNextPause=!0,i.pause(),this.isPlayingSubSection.set(!1),this._clearRangeStop(),t&&t()},o=()=>{if(i.currentTime>=e-this._epsilon){n();return}this._rangeStopRafId=requestAnimationFrame(o)},r=i;if(typeof r.requestVideoFrameCallback=="function"){let c=()=>{if(i.currentTime>=e-this._epsilon){n();return}this._rangeStopRvfcId=r.requestVideoFrameCallback(c)};this._rangeStopRvfcId=r.requestVideoFrameCallback(c)}else this._rangeStopRafId=requestAnimationFrame(o);let a=()=>{if(this._ignoreNextPause){this._ignoreNextPause=!1;return}this.isPlayingSubSection.set(!1),this._clearPlayAllQueue(),this._clearRangeStop()};i.addEventListener("pause",a),this._rangeStopCleanup=()=>{i.removeEventListener("pause",a),this._rangeStopRafId!=null&&(cancelAnimationFrame(this._rangeStopRafId),this._rangeStopRafId=null);let c=i;this._rangeStopRvfcId!=null&&typeof c.cancelVideoFrameCallback=="function"?(c.cancelVideoFrameCallback(this._rangeStopRvfcId),this._rangeStopRvfcId=null):this._rangeStopRvfcId=null}}_clearRangeStop(){this._rangeStopCleanup&&(this._rangeStopCleanup(),this._rangeStopCleanup=null)}_parseTimecodeToSeconds(e){let t=e.trim();if(!t)return null;if(/^\d+(\.\d+)?$/.test(t))return Number(t);let i=t.split(":").map(n=>n.trim());if(i.some(n=>!/^\d+(\.\d+)?$/.test(n)))return null;if(i.length===2){let n=Number(i[0]),o=Number(i[1]);return n*60+o}if(i.length===3){let n=Number(i[0]),o=Number(i[1]),r=Number(i[2]);return n*3600+o*60+r}return null}static \u0275fac=function(t){return new(t||l)};static \u0275prov=ee({token:l,factory:l.\u0275fac,providedIn:"root"})};var me=["videoEl"],pe=(l,e)=>e.url;function he(l,e){l&1&&(d(0,"option"),s(1,"Loading sources..."),u())}function ve(l,e){if(l&1&&(d(0,"option",5),s(1),u()),l&2){let t,i=e.$implicit,n=_();O("value",i.url)("selected",((t=n.video.selectedSource())==null?null:t.url)===i.url),m(),w(i.name)}}function fe(l,e){if(l&1){let t=k();d(0,"tr",27)(1,"td",28)(2,"input",29),V("input",function(n){let o=h(t).$index,r=_(2);return v(r.onSubSectionNameInput(o,n.target.value))}),u()(),d(3,"td",28)(4,"input",30),V("input",function(n){let o=h(t).$index,r=_(2);return v(r.onSubSectionTimeInput(o,"tcin",n.target.value))}),u()(),d(5,"td",28)(6,"input",30),V("input",function(n){let o=h(t).$index,r=_(2);return v(r.onSubSectionTimeInput(o,"tcout",n.target.value))}),u()(),d(7,"td",28)(8,"span",31)(9,"button",32),V("click",function(){let n=h(t).$implicit,o=_(2);return v(o.playSubsection(n))}),s(10,"\u25B6"),u(),d(11,"button",33),V("click",function(){let n=h(t).$implicit,o=_(2);return v(o.editSubsection(n))}),s(12,"\u270E"),u()()()()}if(l&2){let t=e.$implicit,i=_(2);m(2),O("value",t.name),m(2),O("value",i.toSecondsValue(t.tcin)),m(2),O("value",i.toSecondsValue(t.tcout))}}function be(l,e){if(l&1&&G(0,fe,13,3,"tr",27,ne),l&2){let t=_();J(t.video.selectedSource().subSections)}}function Se(l,e){l&1&&(d(0,"tr")(1,"td",34),s(2,"No subsections loaded."),u()())}var W=class l{constructor(e){this.video=e;C(()=>{let t=this.video.videoSources();if(t.length>0&&!this.video.selectedSource()){let i=t[2]||t[0];if(this.video.selectedSource.set(i),this.videoEl){let n=this.videoEl.nativeElement;n.src=i.url,n.load(),this.video.connectVideo(n)}}}),C(()=>{let t=this.video.subIn(),i=this.video.subOut();t==null&&i==null&&this.tcOutText!==""&&(this.tcOutText="")})}videoEl;tcOutText="";get videoSrc(){return this.video.selectedSource()?.url??""}ngAfterViewInit(){let e=this.videoEl.nativeElement;this.video.selectedSource()&&(e.src=this.videoSrc,e.load(),this.video.connectVideo(e))}onSourceChange(e){let t=e.target.value,i=this.video.videoSources().find(o=>o.url===t)||null;this.video.selectedSource.set(i);let n=this.videoEl.nativeElement;n.pause(),n.src=this.videoSrc,n.load(),this.tcOutText="",this.video.setSubSection(null,null),this.video.setSubIn(null),this.video.setSubOut(null),this.video.connectVideo(n)}onTcOut(e){this.tcOutText=e;let t=de(this.tcOutText);this.video.setSubOut(t)}onSubSectionTimeInput(e,t,i){this.video.updateSubSectionByIndex(e,t,i)}onSubSectionNameInput(e,t){this.video.updateSubSectionByIndex(e,"name",t)}toSecondsValue(e){let t=de(e);return t==null?"":String(t)}editSubsection(e){this.tcOutText=e.tcout,this.video.editSubSection(e)}playSubsection(e){this.tcOutText=e.tcout,this.video.playSubSection(e)}playAllSections(){let e=this.video.selectedSource()?.subSections??[];this.video.playAllSections(e)}formatTime(e){if(e==null||!Number.isFinite(e))return"--";let t=Math.max(0,e),i=Math.floor(t/60),o=(t-i*60).toFixed(2).padStart(5,"0");return i>0?`${i}:${o}`:`${o}s`}static \u0275fac=function(t){return new(t||l)(H(M))};static \u0275cmp=L({type:l,selectors:[["app-videosource"]],viewQuery:function(t,i){if(t&1&&q(me,7),t&2){let n;F(n=X())&&(i.videoEl=n.first)}},decls:69,vars:10,consts:[["videoEl",""],[1,"rounded-2xl","border","border-gray-200","bg-white","p-4","shadow-sm","space-y-4"],[1,"flex","items-center","justify-between","gap-4"],[1,"flex","items-end","gap-3","flex-nowrap","ml-6"],[1,"rounded-lg","border","mr-10","border-gray-200","bg-white","px-4","py-2","text-sm","text-gray-800","focus:border-blue-500","focus:ring-2","focus:ring-blue-200","-ml-5",3,"change","disabled"],[3,"value","selected"],[1,"text-right"],[1,"text-sm","font-semibold","text-gray-900"],[1,"text-xs","text-gray-600"],[1,"rounded-lg","border","border-gray-200","bg-white"],[1,"p-5","flex","items-center","justify-between"],[1,"flex","items-center","gap-2","text-xs","text-gray-700"],["type","button","title","Play all sections",1,"hover:text-gray-900",3,"click"],[1,"w-full","text-xs","text-gray-800"],[1,"bg-gray-50","text-[11px]","text-gray-600"],[1,"px-3","py-2","text-left","font-semibold"],["controls","","preload","auto","playsinline","",1,"w-[64%]","mx-auto","rounded-xl","border","border-gray-200","bg-black"],[1,"text-xs","text-gray-600","flex","items-center","justify-between"],[1,"font-mono"],[1,"flex","items-center","gap-2"],[1,"hidden","sm:block"],[1,"rounded-lg","border","border-gray-200","bg-white","p-3"],[1,"flex","items-end","gap-3","flex-nowrap"],[1,"flex","flex-col"],[1,"text-[11px]","text-gray-600"],["title","TCIN is set from the timeline when you start scrubbing",1,"w-24","rounded-md","border","border-gray-200","bg-gray-50","px-2","py-1","text-xs","text-gray-800","font-mono"],["placeholder","mm:ss",1,"w-24","rounded-md","border","border-gray-300","bg-white","px-2","py-1","text-xs","text-gray-900","outline-none","focus:border-blue-500","focus:ring-2","focus:ring-blue-200",3,"input","value"],[1,"border-t","border-gray-100"],[1,"px-3","py-2"],["type","text",1,"w-28","rounded-md","border","border-gray-300","bg-white","px-2","py-1","text-xs","text-gray-900","outline-none","focus:border-blue-500","focus:ring-2","focus:ring-blue-200",3,"input","value"],["type","number","step","0.01","min","0",1,"w-24","rounded-md","border","border-gray-300","bg-white","px-2","py-1","text-xs","text-gray-900","font-mono","outline-none","focus:border-blue-500","focus:ring-2","focus:ring-blue-200",3,"input","value"],[1,"inline-flex","items-center","gap-2","text-gray-700","text-[15px]"],["type","button","title","Play",1,"hover:text-gray-900",3,"click"],["type","button","title","Edit",1,"hover:text-gray-900",3,"click"],["colspan","4",1,"px-3","py-3","text-gray-500"]],template:function(t,i){if(t&1){let n=k();d(0,"section",1)(1,"div",2)(2,"div",3)(3,"select",4),V("change",function(r){return h(n),v(i.onSourceChange(r))}),N(4,he,2,0,"option"),G(5,ve,2,3,"option",5,pe),u()(),d(7,"div",6)(8,"h2",7),s(9,"Video Source"),u(),d(10,"p",8),s(11,"HTML5 video wired to ClapVideoSourceService"),u()()(),d(12,"div",9)(13,"div",10)(14,"h2",7),s(15,"Loaded Sections"),u(),d(16,"div",11)(17,"span"),s(18,"Play all sections"),u(),d(19,"button",12),V("click",function(){return h(n),v(i.playAllSections())}),s(20," \u25B6 "),u()()(),d(21,"table",13)(22,"thead",14)(23,"tr")(24,"th",15),s(25,"Name"),u(),d(26,"th",15),s(27,"TCIN"),u(),d(28,"th",15),s(29,"TCOUT"),u(),d(30,"th",15),s(31,"Actions"),u()()(),d(32,"tbody"),N(33,be,2,0)(34,Se,3,0,"tr"),u()()(),re(35,"video",16,0),d(37,"div",17)(38,"div"),s(39,"src: "),d(40,"span",18),s(41),u()(),d(42,"div",19)(43,"div"),s(44," t: "),d(45,"span",18),s(46),u(),s(47,"s / "),d(48,"span",18),s(49),u(),s(50,"s "),u(),d(51,"div",20),s(52," sub: "),d(53,"span",18),s(54),u(),s(55," \u2192 "),d(56,"span",18),s(57),u()()()(),d(58,"div",21)(59,"div",22)(60,"div",23)(61,"label",24),s(62,"TCIN"),u(),d(63,"div",25),s(64),u()(),d(65,"div",23)(66,"label",24),s(67,"TCOUT"),u(),d(68,"input",26),V("input",function(r){return h(n),v(i.onTcOut(r.target.value))}),u()()()()()}if(t&2){let n;m(3),O("disabled",i.video.videoSources().length===0),m(),A(i.video.videoSources().length===0?4:-1),m(),J(i.video.videoSources()),m(28),A(!((n=i.video.selectedSource())==null||n.subSections==null)&&n.subSections.length?33:34),m(8),w(i.videoSrc),m(5),w(i.video.currentTime().toFixed(2)),m(3),w(i.video.duration().toFixed(2)),m(5),w(i.video.subIn()==null?"--":i.video.subIn().toFixed(2)),m(3),w(i.video.subOut()==null?"--":i.video.subOut().toFixed(2)),m(7),Q(" ",i.formatTime(i.video.subIn())," "),m(4),O("value",i.tcOutText)}},encapsulation:2})};function de(l){let e=l.trim();if(!e)return null;if(/^\d+(\.\d+)?$/.test(e))return Number(e);let t=e.split(":").map(i=>i.trim());if(t.some(i=>!/^\d+(\.\d+)?$/.test(i)))return null;if(t.length===2){let i=Number(t[0]),n=Number(t[1]);return i*60+n}if(t.length===3){let i=Number(t[0]),n=Number(t[1]),o=Number(t[2]);return i*3600+n*60+o}return null}var ge=["canvas"],_e=["stage"];function xe(l,e){if(l&1){let t=k();p(0,"div",17)(1,"div",18)(2,"div",19),s(3),b(),p(4,"div",20)(5,"button",21),D("pointerdown",function(n){h(t);let o=_();return v(o.onConfirmPointerDown(n))})("click",function(){h(t);let n=_();return v(n.confirmSubSection())}),s(6," \u2713 "),b(),p(7,"button",22),D("pointerdown",function(n){h(t);let o=_();return v(o.onCancelPointerDown(n))})("click",function(){h(t);let n=_();return v(n.clearSubSection())}),s(8," \u2715 "),b()()()()}if(l&2){let t=_();$("left",t.subOverlayLeftPx,"px")("top",t.subOverlayTopPx,"px"),m(),$("width",t.subOverlayWidthPx,"px"),m(2),Q(" ",t.subOverlayLabel," ")}}var z=class l{canvasRef;stageRef;zone=Z(te);video=Z(M);paddingX=12;rulerHeight=36;lanePaddingTop=10;laneHeight=64;viewStart=0;viewEnd=10;pxPerSecond=80;ctx;dpr=1;ro;rafId=null;isScrubbingLocal=!1;viewReady=!1;hasCtx=!1;showSubOverlay=!1;subOverlayLeftPx=0;subOverlayTopPx=6;subOverlayWidthPx=120;subOverlayLabel="";_onDuration=C(()=>{let e=this.video.duration();e>0?(this.viewStart=0,this.viewEnd=e,this.recomputeScale()):this.requestRender(),this.viewReady&&this.hasCtx&&this.updateOverlay()});_onTime=C(()=>{this.video.currentTime(),this.viewReady&&this.hasCtx&&this.updateOverlay(),this.requestRender()});_onSubSection=C(()=>{this.video.subIn(),this.video.subOut(),this.video.isPlayingSubSection(),this.video.duration(),this.video.selectedSource(),this.video.videoSources(),!(!this.viewReady||!this.hasCtx)&&(this.updateOverlay(),this.requestRender())});get currentTime(){return this.video.currentTime()}get duration(){return this.video.duration()}get pinX(){let e=this.currentTime,t=Math.max(this.viewStart,Math.min(this.viewEnd,e));return this.paddingX+(t-this.viewStart)*this.pxPerSecond}ngAfterViewInit(){let e=this.canvasRef.nativeElement,t=e.getContext("2d");if(!t)throw new Error("2D canvas context not available");this.ctx=t,this.hasCtx=!0,this.viewReady=!0,this.zone.runOutsideAngular(()=>{this.ro=new ResizeObserver(()=>this.resizeAndRender()),this.ro.observe(e)}),this.resizeAndRender()}ngOnDestroy(){this.ro?.disconnect(),this.rafId!==null&&cancelAnimationFrame(this.rafId)}zoomIn(){let e=this.duration;if(!(e>0))return;let t=this.currentTime,i=this.viewEnd-this.viewStart,n=Math.max(1,i/1.5);this.setViewWindowCentered(t,n,e)}zoomOut(){let e=this.duration;if(!(e>0))return;let t=this.currentTime,i=this.viewEnd-this.viewStart,n=Math.min(e,i*1.5);this.setViewWindowCentered(t,n,e)}onPointerDown(e){this.isScrubbingLocal=!0,this.video.beginScrub(),this.stageRef.nativeElement.setPointerCapture(e.pointerId),this.seekFromClientX(e.clientX,!0),e.preventDefault()}onPointerMove(e){this.isScrubbingLocal&&(this.seekFromClientX(e.clientX,!0),e.preventDefault())}onPointerUp(e){this.isScrubbingLocal=!1,this.video.endScrub()}seekFromClientX(e,t){let n=this.canvasRef.nativeElement.getBoundingClientRect(),r=e-n.left-this.paddingX,a=this.viewStart+r/this.pxPerSecond;this.video.setTimeFromTimeline(a),t&&this.video.setSubIn(a),this.requestRender()}confirmSubSection(){let e=this.video.subIn(),t=this.video.subOut();e==null||t==null||(alert("\u2705 I checked!"),this.video.setSubIn(null),this.video.setSubOut(null),this.updateOverlay(),this.requestRender())}clearSubSection(){alert("\u274C I escaped!"),this.video.setSubIn(null),this.video.setSubOut(null),this.updateOverlay(),this.requestRender()}setViewWindowCentered(e,t,i){let n=t/2,o=e-n,r=e+n;if(o<0&&(r-=o,o=0),r>i){let a=r-i;o=Math.max(0,o-a),r=i}this.viewStart=o,this.viewEnd=r,this.recomputeScale(),this.requestRender()}recomputeScale(){let t=this.canvasRef.nativeElement.getBoundingClientRect(),i=Math.max(1,t.width-this.paddingX*2),n=Math.max(.001,this.viewEnd-this.viewStart);this.pxPerSecond=i/n,this.requestRender()}resizeAndRender(){let e=this.canvasRef.nativeElement,t=e.getBoundingClientRect();this.dpr=window.devicePixelRatio||1;let i=Math.max(1,Math.floor(t.width*this.dpr)),n=Math.max(1,Math.floor(t.height*this.dpr));e.width!==i&&(e.width=i),e.height!==n&&(e.height=n),this.duration>0&&this.recomputeScale(),this.requestRender()}requestRender(){this.rafId===null&&(this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.render()}))}render(){if(!this.hasCtx)return;let e=this.canvasRef.nativeElement,t=this.ctx,i=e.width,n=e.height;t.clearRect(0,0,i,n),t.save(),t.scale(this.dpr,this.dpr);let o=i/this.dpr,r=n/this.dpr;t.fillStyle="#ffffff",t.fillRect(0,0,o,r),t.fillStyle="#f9fafb",t.fillRect(0,0,o,this.rulerHeight),t.strokeStyle="#e5e7eb",t.lineWidth=1,t.beginPath(),t.moveTo(0,this.rulerHeight+.5),t.lineTo(o,this.rulerHeight+.5),t.stroke(),t.fillStyle="#f3f4f6",t.fillRect(0,this.rulerHeight,o,r-this.rulerHeight),this.drawLane(t,o),this.drawRuler(t,o),this.drawSubSection(t,o),this.drawSourceSubSections(t,o),t.restore(),this.updateOverlay()}drawRuler(e,t){let i=this.paddingX,n=t-this.paddingX,o=this.duration;if(e.font="11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial",!(o>0)){e.fillStyle="#9ca3af",e.fillText("Loading metadata\u2026",this.paddingX,14);return}let r=this.viewEnd-this.viewStart,a=1;r>60&&(a=5),r>180&&(a=10);let c=5;a===5&&(c=10),a===10&&(c=30),e.fillStyle="#6b7280",e.strokeStyle="#d1d5db",e.lineWidth=1;let y=Math.floor(this.viewStart/a)*a,E=this.viewEnd;for(let g=y;g<=E+1e-4;g+=a){let S=i+(g-this.viewStart)*this.pxPerSecond;if(S<i-50||S>n+50)continue;let x=Math.round(g)%c===0,f=6,R=x?28:18;e.beginPath(),e.moveTo(S+.5,f),e.lineTo(S+.5,R),e.stroke(),x&&e.fillText(this.formatTime(g),S+4,14)}}drawLane(e,t){let i=this.rulerHeight+this.lanePaddingTop,n=this.paddingX,o=t-this.paddingX*2,r=i,a=this.laneHeight;e.fillStyle="#ffffff",e.fillRect(n,r,o,a),e.strokeStyle="#e5e7eb",e.lineWidth=1,e.strokeRect(n+.5,r+.5,o-1,a-1)}drawSourceSubSections(e,t){let i=this.video.selectedSource();if(!i||!i.subSections||i.subSections.length===0)return;let o=this.rulerHeight+this.lanePaddingTop,r=this.laneHeight,a=this.paddingX,c=t-this.paddingX;for(let y of i.subSections){let E=this.parseHHMMSS(y.tcin),g=this.parseHHMMSS(y.tcout),S=this.timeToX(E),x=this.timeToX(g),f=Math.min(S,x),R=Math.max(S,x),I=Math.max(a,Math.min(c,f)),j=Math.max(a,Math.min(c,R))-I;j<=0||(e.save(),e.globalAlpha=.3,e.fillStyle="#22c55e",e.fillRect(I,o,j,r),e.globalAlpha=.8,e.strokeStyle="#16a34a",e.lineWidth=1,e.strokeRect(I+.5,o+.5,j-1,r-1),e.restore())}}parseHHMMSS(e){let t=e.split(":").map(Number);return t.length===3?t[0]*3600+t[1]*60+t[2]:t.length===2?t[0]*60+t[1]:t[0]||0}drawSubSection(e,t){let i=this.video.subIn(),n=this.video.subOut();if(i==null||n==null)return;let o=this.timeToX(i),r=this.timeToX(n),a=Math.min(o,r),c=Math.max(o,r),E=this.rulerHeight+this.lanePaddingTop,g=this.laneHeight,S=this.paddingX,x=t-this.paddingX,f=Math.max(S,Math.min(x,a)),R=Math.max(S,Math.min(x,c)),I=Math.max(1,R-f);e.save(),e.globalAlpha=.22,e.fillStyle="#2563eb",e.fillRect(f,E,I,g),e.restore(),e.save(),e.globalAlpha=.85,e.strokeStyle="#1d4ed8",e.lineWidth=1,e.strokeRect(f+.5,E+.5,I-1,g-1),e.restore()}updateOverlay(){let e=this.video.duration(),t=this.video.subIn(),i=this.video.subOut();if(this.video.isPlayingSubSection()||!(e>0)||t==null||i==null||Math.abs(t-i)<.001){this.showSubOverlay=!1;return}let o=this.canvasRef.nativeElement.width/this.dpr,r=this.timeToX(t),a=this.timeToX(i),c=Math.min(r,a),y=Math.max(r,a),E=this.paddingX,g=o-this.paddingX,S=Math.max(E,Math.min(g,c)),x=Math.max(E,Math.min(g,y)),f=Math.max(110,x-S);this.showSubOverlay=!0,this.subOverlayLeftPx=S,this.subOverlayWidthPx=f,this.subOverlayLabel=`${this.formatTimeOverlay(t)} \u2192 ${this.formatTimeOverlay(i)}`}timeToX(e){return this.paddingX+(e-this.viewStart)*this.pxPerSecond}formatTime(e){let t=Math.floor(Math.max(0,e)),i=Math.floor(t/60),n=t%60;return i>0?`${i}:${String(n).padStart(2,"0")}`:`${n}s`}formatTimeOverlay(e){let t=Math.max(0,e),i=Math.floor(t/60),o=(t-i*60).toFixed(2).padStart(5,"0");return i>0?`${i}:${o}`:`${o}s`}onConfirmPointerDown(e){e.stopPropagation(),e.preventDefault()}onCancelPointerDown(e){e.stopPropagation(),e.preventDefault()}static \u0275fac=function(t){return new(t||l)};static \u0275cmp=L({type:l,selectors:[["app-timeline"]],viewQuery:function(t,i){if(t&1&&q(ge,7)(_e,7),t&2){let n;F(n=X())&&(i.canvasRef=n.first),F(n=X())&&(i.stageRef=n.first)}},decls:34,vars:6,consts:[["stage",""],["canvas",""],[1,"rounded-2xl","border","border-gray-200","bg-white","p-4","shadow-sm"],[1,"flex","items-center","justify-between","gap-4"],[1,"text-sm","font-semibold","text-gray-900"],[1,"text-xs","text-gray-600"],[1,"flex","items-center","gap-2"],["type","button",1,"rounded-xl","border","border-gray-200","bg-white","px-3","py-2","text-xs","font-medium","text-gray-800","hover:bg-gray-50","transition",3,"click"],[1,"relative","mt-4","rounded-xl","border","border-gray-200","bg-gray-50","overflow-hidden","select-none","touch-none",3,"pointerdown","pointermove","pointerup","pointercancel"],[1,"block","w-full","h-[130px]","bg-white"],["class","absolute z-20","style","pointer-events: none;",3,"left","top",4,"ngIf"],[1,"absolute","top-0","bottom-0","cursor-ew-resize"],[1,"relative","-translate-x-1/2"],[1,"mt-2","h-3","w-3","rounded-full","bg-blue-600","shadow"],[1,"absolute","top-0","bottom-0","left-0","-translate-x-1/2","w-[2px]","bg-blue-600/80"],[1,"mt-3","text-xs","text-gray-600","flex","items-center","justify-between"],[1,"font-mono"],[1,"absolute","z-20",2,"pointer-events","none"],[1,"flex","items-center","gap-1","rounded-lg","border","border-gray-200","bg-white/95","shadow-sm","px-2","py-1"],[1,"text-[11px]","text-gray-700","font-mono","whitespace-nowrap","truncate"],[1,"ml-auto","flex","items-center","gap-1",2,"pointer-events","auto"],["type","button","title","Confirm subsection",1,"rounded-md","px-2","py-1","text-[11px]","font-semibold","bg-blue-600","text-white","hover:bg-blue-700",3,"pointerdown","click"],["type","button","title","Clear subsection",1,"rounded-md","px-2","py-1","text-[11px]","font-semibold","bg-gray-100","text-gray-800","hover:bg-gray-200",3,"pointerdown","click"]],template:function(t,i){if(t&1){let n=k();p(0,"section",2)(1,"div",3)(2,"div")(3,"h2",4),s(4,"Timeline"),b(),p(5,"p",5),s(6,"Ruler + edit lane + scrub pin"),b()(),p(7,"div",6)(8,"button",7),D("click",function(){return h(n),v(i.zoomOut())}),s(9," Zoom - "),b(),p(10,"button",7),D("click",function(){return h(n),v(i.zoomIn())}),s(11," Zoom + "),b()()(),p(12,"div",8,0),D("pointerdown",function(r){return h(n),v(i.onPointerDown(r))})("pointermove",function(r){return h(n),v(i.onPointerMove(r))})("pointerup",function(r){return h(n),v(i.onPointerUp(r))})("pointercancel",function(r){return h(n),v(i.onPointerUp(r))}),P(14,"canvas",9,1),ie(16,xe,9,7,"div",10),p(17,"div",11)(18,"div",12),P(19,"div",13),b(),P(20,"div",14),b()(),p(21,"div",15)(22,"div"),s(23," t: "),p(24,"span",16),s(25),b(),s(26,"s / "),p(27,"span",16),s(28),b(),s(29,"s "),b(),p(30,"div"),s(31," px/s: "),p(32,"span",16),s(33),b()()()()}t&2&&(m(16),oe("ngIf",i.showSubOverlay),m(),$("left",i.pinX,"px"),m(8),w(i.currentTime.toFixed(2)),m(3),w(i.duration.toFixed(2)),m(5),w(i.pxPerSecond.toFixed(1)))},dependencies:[ae,se],encapsulation:2})};function ye(l,e){l&1&&(p(0,"div",1)(1,"div",6),P(2,"div",7),p(3,"p",8),s(4,"Loading experience..."),b()()())}var ce=class l{constructor(e){this.videoService=e}static \u0275fac=function(t){return new(t||l)(H(M))};static \u0275cmp=L({type:l,selectors:[["app-home"]],decls:10,vars:1,consts:[[1,"relative","space-y-6"],[1,"absolute","inset-0","z-50","flex","items-center","justify-center","bg-white/70","backdrop-blur-[2px]"],[1,"space-y-2"],[1,"text-2xl","font-semibold","text-gray-900"],[1,"text-gray-600","max-w-xl"],[1,"flex","flex-col","gap-6"],[1,"flex","flex-col","items-center","gap-3"],[1,"h-10","w-10","animate-spin","rounded-full","border-4","border-gray-200","border-t-blue-600"],[1,"text-sm","font-medium","text-gray-700"]],template:function(t,i){t&1&&(p(0,"section",0),N(1,ye,5,0,"div",1),p(2,"div",2)(3,"h1",3),s(4,"Clapline"),b(),p(5,"p",4),s(6," Experimental playground for video-editing tools. "),b()(),p(7,"div",5),P(8,"app-videosource")(9,"app-timeline"),b()()),t&2&&(m(),A(i.videoService.isLoading()?1:-1))},dependencies:[W,z],encapsulation:2})};export{ce as HomeComponent};
